<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ospedale RPG - Full Screen</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="stile.css">
</head>
<body>

    <div id="game-screen">
        <div id="top-controls">
            <div id="sound-toggle" onclick="toggleSound()">
                <span id="sound-icon">ðŸ”Š</span>
            </div>
            <div id="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">ðŸŒ™</span>
            </div>
        </div>
        <audio id="soundtrack" loop>
            <source src="soundtrack.mp3" type="audio/mpeg">
        </audio>
        
        <div class="sign">USCITA</div>
        <div class="door"><img id="door-img" src="door.png" alt="Porta"></div>
        <div class="background-decor"></div>

        <div id="nurse-container">
            <img id="nurse-img" src="jo.png" alt="Infermiera">
        </div>

        <div id="dialog-area">
            <div id="resize-handle"></div>
            <div id="tabs-row">
                <div id="tabs-container">
                    <!-- Le tabs verranno inserite qui dinamicamente -->
                </div>
                <div id="exam-counter">Esami: 0</div>
            </div>
            
            <div id="text-content">In attesa...</div>

            <div id="controls">
                <button onclick="accettaPaziente()">ACCETTA PAZIENTE</button>
            </div>
        </div>
    </div>
    <script src="casi.js"></script>
    <script>
        // ==========================================
        //  AUDIO CONTROL
        // ==========================================
        
        const soundtrack = document.getElementById('soundtrack');
        soundtrack.volume = 0.5; // Volume ridotto
        const soundIcon = document.getElementById('sound-icon');
        const clickSound = new Audio('click.mp3');
        const errorSound = new Audio('error.ogg');
        let isMuted = true;
        let skipNextClick = false; // Per evitare click quando c'Ã¨ errore

        function playClick() {
            if (isMuted) return;
            if (skipNextClick) {
                skipNextClick = false;
                return;
            }
            clickSound.currentTime = 0;
            clickSound.play().catch(() => {});
        }

        function playError() {
            if (isMuted) return;
            skipNextClick = true;
            errorSound.currentTime = 0;
            errorSound.play().catch(() => {});
        }

        // Aggiungi suono click a tutti i button e tab
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.id === 'sound-toggle' || e.target.id === 'sound-icon' || e.target.classList.contains('tab')) {
                playClick();
            }
        });

        function toggleSound() {
            if (isMuted) {
                soundtrack.play();
                soundIcon.textContent = 'ðŸ”‡';
                isMuted = false;
            } else {
                soundtrack.pause();
                soundIcon.textContent = 'ðŸ”Š';
                isMuted = true;
            }
        }

        // ==========================================
        //  THEME CONTROL (Dark Mode)
        // ==========================================
        
        const themeIcon = document.getElementById('theme-icon');
        let isDarkMode = false;

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            themeIcon.textContent = isDarkMode ? 'â˜€ï¸' : 'ðŸŒ™';
            
            // Forza repaint del testo per evitare bug di rendering
            const textEl = document.getElementById('text-content');
            const scrollPos = textEl.scrollTop;
            textEl.style.display = 'none';
            textEl.offsetHeight; // Trigger reflow
            textEl.style.display = '';
            textEl.scrollTop = scrollPos;
        }

        // ==========================================
        //  RESIZE DIALOG AREA (Tendina)
        // ==========================================
        
        const dialogArea = document.getElementById('dialog-area');
        const resizeHandle = document.getElementById('resize-handle');
        let isResizing = false;
        let startY = 0;
        let startHeight = 0;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            startY = e.clientY;
            startHeight = dialogArea.offsetHeight;
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const deltaY = startY - e.clientY;
            const newHeight = Math.min(Math.max(startHeight + deltaY, 150), window.innerHeight * 0.8);
            dialogArea.style.height = newHeight + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        // Supporto touch per mobile
        resizeHandle.addEventListener('touchstart', (e) => {
            isResizing = true;
            startY = e.touches[0].clientY;
            startHeight = dialogArea.offsetHeight;
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (!isResizing) return;
            const deltaY = startY - e.touches[0].clientY;
            const newHeight = Math.min(Math.max(startHeight + deltaY, 150), window.innerHeight * 0.8);
            dialogArea.style.height = newHeight + 'px';
        }, { passive: false });

        document.addEventListener('touchend', () => {
            isResizing = false;
        });

        // ==========================================
        //  LOGICA DI GIOCO
        // ==========================================

        const textElement = document.getElementById('text-content');
        let selectElement = document.getElementById('exam-selector');
        const tabsContainer = document.getElementById('tabs-container');
        let casoCorrenteObj = null;
        let tabs = []; // Array di oggetti {nome, contenuto, id}
        let tabAttivaId = null;
        let timerStart = null; // Timestamp di inizio caso

        function formatTempo(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minuti = Math.floor(totalSeconds / 60);
            const secondi = totalSeconds % 60;
            if (minuti > 0) {
                return minuti + " minuti " + secondi + " secondi.";
            }
            return secondi + " secondi.";
        }

        function creaTabs() {
            tabsContainer.innerHTML = '';
            tabs.forEach(tab => {
                const tabElement = document.createElement('div');
                tabElement.className = 'tab' + (tab.id === tabAttivaId ? ' active' : '');
                tabElement.textContent = tab.nome;
                tabElement.onclick = () => mostraTab(tab.id);
                tabsContainer.appendChild(tabElement);
                
                // Scrolla automaticamente sulla tab attiva
                if (tab.id === tabAttivaId) {
                    setTimeout(() => {
                        tabElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center'
                        });
                    }, 10);
                }
            });
            
            // Aggiorna contatore esami (tabs - 1, escludendo "Infermiera Jo")
            const numEsami = tabs.filter(t => t.id !== 'caso' && t.id !== 'soluzione').length;
            document.getElementById('exam-counter').textContent = 'Esami: ' + numEsami;
        }

        function mostraTab(tabId) {
            // Ferma il typewriter se in corso
            clearInterval(typeInterval);
            
            tabAttivaId = tabId;
            const tab = tabs.find(t => t.id === tabId);
            if (tab) {
                textElement.textContent = tab.contenuto;
                textElement.style.whiteSpace = "pre-wrap";
                textElement.scrollTop = 0;
                creaTabs(); // Aggiorna l'aspetto delle tabs
            }
        }

        function aggiungiOAggiornaCaso(contenuto) {
            const casoTab = tabs.find(t => t.id === 'caso');
            if (casoTab) {
                casoTab.contenuto = contenuto;
            } else {
                tabs.unshift({
                    id: 'caso',
                    nome: 'Infermiera Jo',
                    contenuto: contenuto
                });
            }
            tabAttivaId = 'caso';
            creaTabs();
            typeWriter(contenuto, 'caso');
        }

        function caricaCaso(indice = null) {
            if (indice === null || indice >= casi.length) {
                indice = Math.floor(Math.random() * casi.length);
            }
            console.log(indice);
            casoCorrenteObj = casi[indice];
            
            // Avvia il timer
            timerStart = Date.now();
            
            // Resetta le tabs (mantiene solo il caso)
            tabs = [];
            
            const testoCompleto = "SESSO: "+casoCorrenteObj.sesso+"\nETÃ€: "+casoCorrenteObj.eta+"\nSINTOMI: "+casoCorrenteObj.sintomi+"\nANAMNESI: "+casoCorrenteObj.anamnesi+"\n"+casoCorrenteObj.note_infermiera;
            aggiungiOAggiornaCaso(testoCompleto);

            // Popola menu
            selectElement.innerHTML = '<option value="" disabled selected>-- Scegli un esame --</option>';
            for (let categoria in esamiDisponibili) {
                let optgroup = document.createElement("optgroup");
                optgroup.label = categoria;

                for (let nomeEsame of esamiDisponibili[categoria]) {
                    let option = document.createElement("option");
                    option.value = nomeEsame;
                    option.text = nomeEsame.replaceAll("_", " ");
                    optgroup.appendChild(option);
                }

                selectElement.appendChild(optgroup);
            }
        }

        function eseguiEsame() {
            const esameScelto = selectElement.value;

            if (!esameScelto) {
                // Feedback visivo e sonoro se non si sceglie nulla
                playError();
                selectElement.style.borderColor = "red";
                setTimeout(() => selectElement.style.borderColor = "#333", 500);
                return;
            }

            const risultato = casoCorrenteObj[esameScelto];
            const nomeEsameLeggibile = esameScelto.replaceAll("_", " ");
            let contenuto;
            
            if (risultato == undefined) {
                contenuto = "Non ho programmato risultati per \"" + nomeEsameLeggibile + "\" in questo caso, il che significa che probabilmente Ã¨ inerte, comunque potresti essere fuori strada.";
            } else {
                contenuto = "RISULTATO " + nomeEsameLeggibile + ": " + risultato;
            }

            // Ferma eventuale typewriter in corso
            clearInterval(typeInterval);

            // Crea o aggiorna la tab per questo esame
            const tabEsistente = tabs.find(t => t.id === esameScelto);
            if (tabEsistente) {
                tabEsistente.contenuto = contenuto;
                tabAttivaId = esameScelto; 
                textElement.textContent = contenuto;
                textElement.style.whiteSpace = "pre-wrap";
                textElement.scrollTop = 0;
                creaTabs();
                return;
            } else {
                tabs.push({
                    id: esameScelto,
                    nome: nomeEsameLeggibile,
                    contenuto: contenuto
                });
            }

            // Aggiorna tab attiva PRIMA di creare le tabs
            tabAttivaId = esameScelto; 
            creaTabs(); // ricrea le tabs con quella attiva
            typeWriter(contenuto);
        }

        // Effetto macchina da scrivere
        let typeInterval;
        function typeWriter(text, tabId = null) {
            if (tabId) tabAttivaId = tabId;
            textElement.style.whiteSpace = "pre-wrap";
            clearInterval(typeInterval);
            textElement.textContent = "";
            textElement.scrollTop = 0;
            let i = 0;
            typeInterval = setInterval(() => {
                if (i < text.length) {
                    textElement.textContent += text.charAt(i);
                    i++;
                    textElement.scrollTop = textElement.scrollHeight;
                } else {
                    clearInterval(typeInterval);
                }
            }, 15); 
        }

    function rivelasol() {
        const conferma = confirm("Sei sicuro di voler rivelare la soluzione del caso?");

        if (!casoCorrenteObj || !conferma) return;

        // Calcola il tempo impiegato
        const tempoImpiegato = Date.now() - timerStart;
        const tempo = formatTempo(tempoImpiegato);

        const soluzione = "La soluzione del caso Ã¨: " + casoCorrenteObj.nome_malattia + ".\nTempo impiegato: " + tempo;

        // Crea o aggiorna la tab SOLUZIONE
        tabs.push({
            id: 'soluzione',
            nome: 'SOLUZIONE',
            contenuto: soluzione
        });
        
        tabAttivaId = 'soluzione';
        creaTabs();
        typeWriter(soluzione);

        // Svuota i controlli e aggiunge solo il pulsante "Nuovo Caso"
        const controls = document.getElementById('controls');
        controls.innerHTML = '';
        const nuovoCasoBtn = document.createElement('button');
        const condividi = document.createElement('button');
        nuovoCasoBtn.textContent = 'NUOVO CASO';
        condividi.textContent = 'CONDIVIDI CASO';
        condividi.onclick = () => {
             navigator.clipboard.writeText("https://cole43623.github.io/house/?id="+(casoCorrenteObj.id));
             alert("Link copiato!");
        };
        nuovoCasoBtn.onclick = () => {
            controls.innerHTML = `
                <select id="exam-selector">
                    <option value="" disabled selected>-- Scegli un esame --</option>
                </select>
                <button onclick="eseguiEsame()">ESEGUI ESAME</button>
                <button onclick="rivelasol()">SVELA SOLUZIONE</button>
            `;
            selectElement = document.getElementById('exam-selector');
            let indice2 = Math.floor(Math.random() * casi.length);
            while (indice2 == casoCorrenteObj.id) {
                indice2 = Math.floor(Math.random() * casi.length);
            }
            caricaCaso(indice2);
        };
        controls.appendChild(nuovoCasoBtn);
        controls.appendChild(condividi);
    }

        // Funzione per mostrare intro
        function mostraIntro() {
            const ora = new Date().getHours();
            const saluto = (ora >= 6 && ora < 18) ? "Buongiorno" : "Buonasera";
            const messaggio = saluto + " doc! Abbiamo dei nuovi pazienti da visitare.";
            
            tabs = [{
                id: 'caso',
                nome: 'Infermiera Jo',
                contenuto: messaggio
            }];
            tabAttivaId = 'caso';
            creaTabs();
            typeWriter(messaggio);
        }

        // Funzione per accettare un paziente
        function accettaPaziente() {
            const controls = document.getElementById('controls');
            controls.innerHTML = `
                <select id="exam-selector">
                    <option value="" disabled selected>-- Scegli un esame --</option>
                </select>
                <button onclick="eseguiEsame()">ESEGUI ESAME</button>
                <button onclick="rivelasol()">SVELA SOLUZIONE</button>
            `;
            selectElement = document.getElementById('exam-selector');
            const id = new URLSearchParams(window.location.search).get('id');
            caricaCaso(id);
        }

        const idParam = new URLSearchParams(window.location.search).get('id');
        if (idParam !== null) {
            accettaPaziente();
        } else {
            mostraIntro();
        }

    </script>
</body>
</html>